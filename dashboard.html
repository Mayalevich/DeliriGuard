<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>NightWatch — Delirium Detection Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #4f46e5;
    --primary-dark: #4338ca;
    --secondary: #64748b;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --bg: #0f172a;
    --bg-card: #1e293b;
    --bg-hover: #334155;
    --text: #f1f5f9;
    --text-muted: #94a3b8;
    --border: #334155;
    --shadow: rgba(0, 0, 0, 0.3);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
    color: var(--text);
    min-height: 100vh;
    padding: 0;
    margin: 0;
  }

  /* Header */
  header {
    background: rgba(30, 41, 59, 0.8);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border);
    padding: 1.5rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 4px 6px var(--shadow);
  }

  .brand {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .brand h1 {
    font-size: 1.75rem;
    font-weight: 700;
    background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0;
  }

  .brand .subtitle {
    color: var(--text-muted);
    font-size: 0.875rem;
  }

  .header-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
  }

  /* Buttons */
  .btn {
    padding: 0.625rem 1.25rem;
    border: none;
    border-radius: 0.5rem;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
  }

  .btn-primary {
    background: var(--primary);
    color: white;
  }

  .btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
  }

  .btn-secondary {
    background: var(--secondary);
    color: white;
  }

  .btn-secondary:hover {
    background: #475569;
  }

  .btn-ghost {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn-ghost:hover {
    background: rgba(255, 255, 255, 0.15);
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
  }

  .status-badge {
    padding: 0.5rem 1rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .status-connected {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success);
    border: 1px solid rgba(16, 185, 129, 0.3);
  }

  .status-disconnected {
    background: rgba(239, 68, 68, 0.2);
    color: var(--danger);
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  /* Main Content */
  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    background: rgba(30, 41, 59, 0.5);
    padding: 0.5rem;
    border-radius: 0.75rem;
    backdrop-filter: blur(10px);
  }

  .tab-btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 0.5rem;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    position: relative;
  }

  .tab-btn:hover {
    color: var(--text);
    background: rgba(255, 255, 255, 0.05);
  }

  .tab-btn.active {
    color: white;
    background: var(--primary);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
  }

  /* Cards */
  .card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 1rem;
    padding: 1.5rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px var(--shadow);
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px var(--shadow);
    border-color: var(--primary);
  }

  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .card-title {
    font-size: 1.125rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Grids */
  .grid {
    display: grid;
    gap: 1.5rem;
  }

  .grid-2 {
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  }

  .grid-3 {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  }

  .grid-4 {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }

  /* Metrics */
  .metric {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .metric-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    font-weight: 600;
  }

  .metric-value {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1;
  }

  .metric-value.large {
    font-size: 3rem;
  }

  .metric-subtitle {
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  /* Badges */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .badge-success {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success);
    border: 1px solid rgba(16, 185, 129, 0.3);
  }

  .badge-warning {
    background: rgba(245, 158, 11, 0.2);
    color: var(--warning);
    border: 1px solid rgba(245, 158, 11, 0.3);
  }

  .badge-danger {
    background: rgba(239, 68, 68, 0.2);
    color: var(--danger);
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  .badge-info {
    background: rgba(59, 130, 246, 0.2);
    color: #60a5fa;
    border: 1px solid rgba(59, 130, 246, 0.3);
  }

  /* Charts */
  .chart-container {
    position: relative;
    height: 300px;
    margin-top: 1rem;
  }

  canvas {
    max-height: 100%;
  }

  /* Section Panels */
  .section-panel {
    display: none;
    animation: fadeIn 0.3s ease;
  }

  .section-panel.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Cognitive Assessment Section */
  .assessment-card {
    background: linear-gradient(135deg, rgba(79, 70, 229, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
    border: 1px solid rgba(139, 92, 246, 0.3);
  }

  .score-ring {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    margin: 0 auto;
  }

  .score-ring-inner {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: var(--bg-card);
  }

  .score-number {
    font-size: 2rem;
    font-weight: 700;
  }

  .score-label {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  /* Event Log */
  #log {
    font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
    font-size: 0.75rem;
    line-height: 1.6;
    height: 200px;
    overflow-y: auto;
    background: #0b1020;
    color: #cbd5e1;
    border-radius: 0.5rem;
    padding: 1rem;
    border: 1px solid var(--border);
  }

  /* Responsive */
  @media (max-width: 768px) {
    header {
      padding: 1rem;
    }

    .container {
      padding: 1rem;
    }

    .grid-2, .grid-3, .grid-4 {
      grid-template-columns: 1fr;
    }

    .header-actions {
      width: 100%;
      justify-content: flex-start;
    }
  }

  /* Loading Animation */
  .pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: var(--bg);
  }

  ::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--secondary);
  }
</style>
</head>
<body>
  <header>
    <div class="brand">
      <h1><i class="fas fa-moon"></i> NightWatch</h1>
      <div class="subtitle" id="hint">Delirium Detection System — Sleep & Cognitive Monitoring</div>
    </div>
    <div class="header-actions">
      <a href="/reports" class="btn btn-ghost" target="_blank">
        <i class="fas fa-chart-line"></i> Analytics
      </a>
      <button class="btn btn-primary" id="connectBtn">
        <i class="fas fa-plug"></i> <span>Connect</span>
      </button>
      <button class="btn btn-ghost" id="clearBtn">
        <i class="fas fa-trash"></i> Clear
      </button>
      <span class="status-badge status-disconnected" id="status">
        <i class="fas fa-circle"></i> Disconnected
      </span>
    </div>
  </header>

  <div class="container">
    <nav class="tabs">
      <button class="tab-btn active" id="tabOverview">
        <i class="fas fa-home"></i> Overview
      </button>
      <button class="tab-btn" id="tabSleep">
        <i class="fas fa-bed"></i> Sleep Monitoring
      </button>
      <button class="tab-btn" id="tabCognitive">
        <i class="fas fa-brain"></i> Cognitive Assessment
      </button>
    </nav>

    <!-- Overview Panel -->
    <section class="section-panel active" id="overviewPanel">
      <div class="grid grid-4" style="margin-bottom: 1.5rem;">
        <div class="card">
          <div class="metric">
            <div class="metric-label">Sleep Score</div>
            <div class="metric-value large" id="overviewScore">–</div>
            <div class="metric-subtitle" id="overviewScoreHint">Awaiting data…</div>
        </div>
        </div>
        <div class="card">
          <div class="metric">
            <div class="metric-label">Restfulness</div>
            <div class="metric-value" id="overviewRest">–</div>
            <span class="badge badge-success" id="overviewRestBadge" style="margin-top: 0.5rem;">Idle</span>
        </div>
        </div>
        <div class="card">
          <div class="metric">
            <div class="metric-label">Latest Assessment</div>
            <div class="metric-value" id="overviewCognitiveScore">–</div>
            <div class="metric-subtitle" id="overviewCognitiveAlert">No data</div>
      </div>
        </div>
        <div class="card">
          <div class="metric">
            <div class="metric-label">Delirium Risk</div>
            <div class="metric-value" id="overviewRisk">Low</div>
            <div class="metric-subtitle">Combined assessment</div>
        </div>
        </div>
      </div>

      <div class="grid grid-2" style="margin-bottom: 1.5rem;">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-wave-square"></i> Movement Status</div>
          </div>
          <div class="metric-value" style="font-size: 1.25rem; margin-bottom: 1rem;" id="overviewMovement">Head – · Body – · Leg –</div>
          <div class="metric-subtitle" id="overviewRestHint">Movement status by body region</div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-thermometer-half"></i> Environment</div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <div><span class="metric-label">Temperature</span> <span class="metric-value" style="font-size: 1.5rem;" id="overviewEnvironmentTemp">– °C</span></div>
            <div><span class="metric-label">Light</span> <span class="metric-value" style="font-size: 1.5rem;" id="overviewEnvironmentLight">–</span></div>
            <div><span class="metric-label">Sound RMS</span> <span class="metric-value" style="font-size: 1.5rem;" id="overviewEnvironmentSound">–</span></div>
          </div>
        </div>
      </div>

      <div class="grid grid-3">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-satellite-dish"></i> Monitoring</div>
          </div>
          <div class="metric-value" style="font-size: 1.25rem;" id="overviewMonitoring">Active</div>
          <div class="metric-subtitle" id="overviewMonitoringHint">System status</div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-clock"></i> Session Time</div>
          </div>
          <div class="metric-value" style="font-size: 1.25rem;" id="overviewTime">0.0 s</div>
          <div class="metric-subtitle">Uptime</div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-chart-bar"></i> Events/Min</div>
          </div>
          <div class="metric-value" style="font-size: 1.25rem;" id="overviewEvents">H0 · B0 · L0</div>
          <div class="metric-subtitle">Head · Body · Leg</div>
        </div>
      </div>
  </section>

    <!-- Sleep Monitoring Panel -->
    <section class="section-panel" id="sleepPanel">
      <div class="grid grid-4" style="margin-bottom: 1.5rem;">
    <div class="card">
          <div class="metric">
            <div class="metric-label">Sleep Score</div>
            <div class="metric-value large" id="scoreVal">100</div>
      </div>
        </div>
        <div class="card">
          <div class="metric">
            <div class="metric-label">Head RMS</div>
            <div class="metric-value" id="rmsH">0.0</div>
            <span class="badge badge-success" id="movH" style="margin-top: 0.5rem;">Idle</span>
          </div>
        </div>
        <div class="card">
          <div class="metric">
            <div class="metric-label">Body RMS</div>
            <div class="metric-value" id="rmsB">0.0</div>
            <span class="badge badge-success" id="movB" style="margin-top: 0.5rem;">Idle</span>
          </div>
        </div>
        <div class="card">
          <div class="metric">
            <div class="metric-label">Leg RMS</div>
            <div class="metric-value" id="rmsL">0.0</div>
            <span class="badge badge-success" id="movL" style="margin-top: 0.5rem;">Idle</span>
          </div>
        </div>
      </div>

      <div class="grid grid-2" style="margin-bottom: 1.5rem;">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-chart-line"></i> RMS Movement (Last 5 min)</div>
            <span class="metric-subtitle" id="pointsA">0 pts</span>
          </div>
          <div class="chart-container">
      <canvas id="rmsChart"></canvas>
          </div>
    </div>
    <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-chart-area"></i> Environment (Last 5 min)</div>
            <span class="metric-subtitle" id="pointsB">0 pts</span>
      </div>
          <div class="chart-container">
      <canvas id="auxChart"></canvas>
    </div>
        </div>
      </div>

      <div class="grid grid-3" style="margin-bottom: 1.5rem;">
        <div class="card">
          <div class="metric">
            <div class="metric-label">Uptime</div>
            <div class="metric-value" id="timeVal">0.0 s</div>
          </div>
        </div>
        <div class="card">
          <div class="metric">
            <div class="metric-label">Events (sec)</div>
            <div class="metric-value" id="evSec">H0 / B0 / L0</div>
          </div>
        </div>
        <div class="card">
          <div class="metric">
            <div class="metric-label">Events (minute)</div>
            <div class="metric-value" id="evMin">H0 / B0 / L0</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title"><i class="fas fa-list"></i> Event Log</div>
          <button class="btn btn-ghost" id="clearLog" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">
            <i class="fas fa-eraser"></i> Clear
          </button>
    </div>
    <div id="log"></div>
      </div>
  </section>

    <!-- Cognitive Assessment Panel -->
    <section class="section-panel" id="cognitivePanel">
      <div class="grid grid-2" style="margin-bottom: 1.5rem;">
        <div class="card assessment-card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-brain"></i> Latest Assessment</div>
          </div>
          <div style="text-align: center; padding: 1rem 0;">
            <div class="score-ring" id="scoreRing">
              <div class="score-ring-inner">
                <div class="score-number" id="cognitiveScore">–</div>
                <div class="score-label">/ 12</div>
              </div>
            </div>
            <div style="margin-top: 1rem;">
              <span class="badge badge-success" id="cognitiveAlertBadge">No Data</span>
            </div>
            <div class="metric-subtitle" style="margin-top: 0.5rem;" id="cognitiveTimestamp">No assessments yet</div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-chart-pie"></i> Assessment Breakdown</div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
            <div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span class="metric-label">Orientation</span>
                <span class="metric-value" style="font-size: 1.25rem;" id="cognitiveOrientation">–</span>
              </div>
              <div style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                <div id="cognitiveOrientationBar" style="height: 100%; background: var(--success); width: 0%; transition: width 0.3s ease;"></div>
              </div>
            </div>
            <div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span class="metric-label">Memory</span>
                <span class="metric-value" style="font-size: 1.25rem;" id="cognitiveMemory">–</span>
              </div>
              <div style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                <div id="cognitiveMemoryBar" style="height: 100%; background: var(--success); width: 0%; transition: width 0.3s ease;"></div>
              </div>
            </div>
            <div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span class="metric-label">Attention</span>
                <span class="metric-value" style="font-size: 1.25rem;" id="cognitiveAttention">–</span>
              </div>
              <div style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                <div id="cognitiveAttentionBar" style="height: 100%; background: var(--success); width: 0%; transition: width 0.3s ease;"></div>
              </div>
            </div>
            <div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span class="metric-label">Executive</span>
                <span class="metric-value" style="font-size: 1.25rem;" id="cognitiveExecutive">–</span>
              </div>
              <div style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                <div id="cognitiveExecutiveBar" style="height: 100%; background: var(--success); width: 0%; transition: width 0.3s ease;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title"><i class="fas fa-history"></i> Recent Assessments</div>
        </div>
        <div id="assessmentsList" style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
          <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <div>Loading assessments...</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title"><i class="fas fa-heart"></i> Pet Interactions</div>
        </div>
        <div id="interactionsList" style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
          <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <div>Loading interactions...</div>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
(() => {
  // Elements
  const statusEl = document.getElementById('status');
  const hintEl = document.getElementById('hint');
  const connectBtn = document.getElementById('connectBtn');
  const clearBtn = document.getElementById('clearBtn');
  const logEl = document.getElementById('log');

  // Tab elements
  const tabOverview = document.getElementById('tabOverview');
  const tabSleep = document.getElementById('tabSleep');
  const tabCognitive = document.getElementById('tabCognitive');
  const overviewPanel = document.getElementById('overviewPanel');
  const sleepPanel = document.getElementById('sleepPanel');
  const cognitivePanel = document.getElementById('cognitivePanel');

  // Overview elements
  const overviewScore = document.getElementById('overviewScore');
  const overviewScoreHint = document.getElementById('overviewScoreHint');
  const overviewRest = document.getElementById('overviewRest');
  const overviewRestBadge = document.getElementById('overviewRestBadge');
  const overviewRestHint = document.getElementById('overviewRestHint');
  const overviewMovement = document.getElementById('overviewMovement');
  const overviewEnvironmentTemp = document.getElementById('overviewEnvironmentTemp');
  const overviewEnvironmentLight = document.getElementById('overviewEnvironmentLight');
  const overviewEnvironmentSound = document.getElementById('overviewEnvironmentSound');
  const overviewMonitoring = document.getElementById('overviewMonitoring');
  const overviewMonitoringHint = document.getElementById('overviewMonitoringHint');
  const overviewTime = document.getElementById('overviewTime');
  const overviewEvents = document.getElementById('overviewEvents');
  const overviewCognitiveScore = document.getElementById('overviewCognitiveScore');
  const overviewCognitiveAlert = document.getElementById('overviewCognitiveAlert');
  const overviewRisk = document.getElementById('overviewRisk');

  // Sleep panel elements
  const timeVal = document.getElementById('timeVal');
  const scoreVal = document.getElementById('scoreVal');
  const rmsH = document.getElementById('rmsH');
  const rmsB = document.getElementById('rmsB');
  const rmsL = document.getElementById('rmsL');
  const movH = document.getElementById('movH');
  const movB = document.getElementById('movB');
  const movL = document.getElementById('movL');
  const evSec = document.getElementById('evSec');
  const evMin = document.getElementById('evMin');
  const pointsA = document.getElementById('pointsA');
  const pointsB = document.getElementById('pointsB');

  // Cognitive panel elements
  const cognitiveScore = document.getElementById('cognitiveScore');
  const cognitiveAlertBadge = document.getElementById('cognitiveAlertBadge');
  const cognitiveTimestamp = document.getElementById('cognitiveTimestamp');
  const cognitiveOrientation = document.getElementById('cognitiveOrientation');
  const cognitiveMemory = document.getElementById('cognitiveMemory');
  const cognitiveAttention = document.getElementById('cognitiveAttention');
  const cognitiveExecutive = document.getElementById('cognitiveExecutive');
  const cognitiveOrientationBar = document.getElementById('cognitiveOrientationBar');
  const cognitiveMemoryBar = document.getElementById('cognitiveMemoryBar');
  const cognitiveAttentionBar = document.getElementById('cognitiveAttentionBar');
  const cognitiveExecutiveBar = document.getElementById('cognitiveExecutiveBar');
  const assessmentsList = document.getElementById('assessmentsList');
  const interactionsList = document.getElementById('interactionsList');

  // Tab switching
  function showPanel(panel) {
    [overviewPanel, sleepPanel, cognitivePanel].forEach(p => p.classList.remove('active'));
    [tabOverview, tabSleep, tabCognitive].forEach(t => t.classList.remove('active'));
    
    if (panel === 'overview') {
      overviewPanel.classList.add('active');
      tabOverview.classList.add('active');
    } else if (panel === 'sleep') {
      sleepPanel.classList.add('active');
      tabSleep.classList.add('active');
    } else if (panel === 'cognitive') {
      cognitivePanel.classList.add('active');
      tabCognitive.classList.add('active');
      loadCognitiveData();
    }
  }

  tabOverview.onclick = () => showPanel('overview');
  tabSleep.onclick = () => showPanel('sleep');
  tabCognitive.onclick = () => showPanel('cognitive');

  // Logging
  function log(msg) {
    const ts = new Date().toLocaleTimeString();
    logEl.textContent += `[${ts}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  // Activity badges
  const activityLabels = ['Idle', 'Slight', 'Attention'];
  const activityClasses = ['badge-success', 'badge-warning', 'badge-danger'];

  function setBadge(el, activityLevel) {
    const level = Math.max(0, Math.min(2, Number(activityLevel) || 0));
    el.textContent = activityLabels[level];
    el.className = `badge ${activityClasses[level]}`;
  }

  // Charts
  const maxPoints = 300;
  const rmsChart = new Chart(document.getElementById('rmsChart'), {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Head', data: [], borderColor: '#60a5fa', backgroundColor: 'rgba(96, 165, 250, 0.1)', borderWidth: 2, tension: 0.4, fill: true },
        { label: 'Body', data: [], borderColor: '#34d399', backgroundColor: 'rgba(52, 211, 153, 0.1)', borderWidth: 2, tension: 0.4, fill: true },
        { label: 'Leg', data: [], borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.1)', borderWidth: 2, tension: 0.4, fill: true },
      ]
    },
    options: {
      animation: { duration: 0 },
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: '#f1f5f9' } }
      },
      scales: {
        x: { display: false, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
        y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#94a3b8' } }
      }
    }
  });

  const auxChart = new Chart(document.getElementById('auxChart'), {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Temp (°C)', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 2, tension: 0.4, fill: true },
        { label: 'Light', data: [], borderColor: '#fbbf24', backgroundColor: 'rgba(251, 191, 36, 0.1)', borderWidth: 2, tension: 0.4, fill: true },
        { label: 'Sound RMS', data: [], borderColor: '#22d3ee', backgroundColor: 'rgba(34, 211, 238, 0.1)', borderWidth: 2, tension: 0.4, fill: true },
      ]
    },
    options: {
      animation: { duration: 0 },
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: '#f1f5f9' } }
      },
      scales: {
        x: { display: false, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
        y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#94a3b8' } }
      }
    }
  });

  function pushPoint(chart, arr) {
    chart.data.labels.push('');
    chart.data.datasets.forEach((ds, i) => ds.data.push(Number(arr[i]) || 0));
    if (chart.data.labels.length > maxPoints) {
      chart.data.labels.shift();
      chart.data.datasets.forEach(ds => ds.data.shift());
    }
    chart.update('none');
  }

  function resetCharts() {
    rmsChart.data.labels = [];
    rmsChart.data.datasets.forEach(ds => ds.data = []);
    rmsChart.update();
    auxChart.data.labels = [];
    auxChart.data.datasets.forEach(ds => ds.data = []);
    auxChart.update();
    pointsA.textContent = '0 pts';
    pointsB.textContent = '0 pts';
  }

  // Cognitive data loading
  async function loadCognitiveData() {
    try {
      // Load assessments
      const assessmentsRes = await fetch('/api/assessments?limit=10');
      const assessments = await assessmentsRes.json();
      
      if (assessments.length > 0) {
        const latest = assessments[assessments.length - 1];
        updateCognitiveDisplay(latest);
        renderAssessmentsList(assessments);
      } else {
        assessmentsList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No assessments yet</div>';
      }

      // Load interactions
      const interactionsRes = await fetch('/api/interactions?limit=20');
      const interactions = await interactionsRes.json();
      
      if (interactions.length > 0) {
        renderInteractionsList(interactions);
    } else {
        interactionsList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No interactions yet</div>';
    }
    } catch (e) {
      console.error('Error loading cognitive data:', e);
      assessmentsList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--danger);">Error loading data</div>';
      interactionsList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--danger);">Error loading data</div>';
  }
  }

  function updateCognitiveDisplay(assessment) {
    const score = assessment.total_score || 0;
    const alertLevel = assessment.alert_level || 0;
    
    cognitiveScore.textContent = score;
    cognitiveOrientation.textContent = `${assessment.orientation_score || 0}/3`;
    cognitiveMemory.textContent = `${assessment.memory_score || 0}/3`;
    cognitiveAttention.textContent = `${assessment.attention_score || 0}/3`;
    cognitiveExecutive.textContent = `${assessment.executive_score || 0}/3`;

    // Update progress bars
    cognitiveOrientationBar.style.width = `${((assessment.orientation_score || 0) / 3) * 100}%`;
    cognitiveMemoryBar.style.width = `${((assessment.memory_score || 0) / 3) * 100}%`;
    cognitiveAttentionBar.style.width = `${((assessment.attention_score || 0) / 3) * 100}%`;
    cognitiveExecutiveBar.style.width = `${((assessment.executive_score || 0) / 3) * 100}%`;

    // Update alert badge
    const alertLabels = ['No Risk', 'Mild', 'Moderate', 'Severe'];
    const alertColors = ['badge-success', 'badge-warning', 'badge-warning', 'badge-danger'];
    cognitiveAlertBadge.textContent = alertLabels[alertLevel] || 'Unknown';
    cognitiveAlertBadge.className = `badge ${alertColors[alertLevel] || 'badge-info'}`;

    // Update timestamp
    const date = new Date(assessment.recorded_at);
    cognitiveTimestamp.textContent = date.toLocaleString();

    // Update overview
    overviewCognitiveScore.textContent = `${score}/12`;
    overviewCognitiveAlert.textContent = alertLabels[alertLevel] || 'Unknown';
    
    // Update score ring color
    const scoreRing = document.getElementById('scoreRing');
    const colors = ['#10b981', '#f59e0b', '#f59e0b', '#ef4444'];
    scoreRing.style.border = `4px solid ${colors[alertLevel] || colors[0]}`;
    scoreRing.style.boxShadow = `0 0 20px ${colors[alertLevel] || colors[0]}40`;
  }

  function renderAssessmentsList(assessments) {
    assessmentsList.innerHTML = assessments.slice().reverse().map(a => {
      const date = new Date(a.recorded_at);
      const alertLabels = ['No Risk', 'Mild', 'Moderate', 'Severe'];
      const alertColors = ['badge-success', 'badge-warning', 'badge-warning', 'badge-danger'];
      return `
        <div class="card" style="padding: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 1.5rem; font-weight: 700;">${a.total_score}/12</div>
              <div class="metric-subtitle">${date.toLocaleString()}</div>
            </div>
            <div style="text-align: right;">
              <span class="badge ${alertColors[a.alert_level] || 'badge-info'}">${alertLabels[a.alert_level] || 'Unknown'}</span>
              <div class="metric-subtitle" style="margin-top: 0.5rem;">
                O:${a.orientation_score} M:${a.memory_score} A:${a.attention_score} E:${a.executive_score}
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderInteractionsList(interactions) {
    const interactionNames = ['Feed', 'Play', 'Clean', 'Game'];
    interactionsList.innerHTML = interactions.slice().reverse().slice(0, 10).map(i => {
      const date = new Date(i.recorded_at);
      return `
        <div class="card" style="padding: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 600;">
                <i class="fas fa-${i.interaction_name === 'feed' ? 'utensils' : i.interaction_name === 'play' ? 'gamepad' : i.interaction_name === 'clean' ? 'soap' : 'puzzle-piece'}"></i>
                ${interactionNames[i.interaction_type] || 'Unknown'}
              </div>
              <div class="metric-subtitle">${date.toLocaleString()}</div>
            </div>
            <div style="text-align: right;">
              <span class="badge ${i.success ? 'badge-success' : 'badge-danger'}">
                ${i.success ? 'Success' : 'Failed'}
              </span>
              <div class="metric-subtitle" style="margin-top: 0.5rem;">${i.response_time_ms}ms</div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // Update overview
  function updateOverview(payload) {
     const score = Number(payload.SleepScore) || 0;
     overviewScore.textContent = score.toFixed(0);
     overviewScoreHint.textContent = describeScore(score);
    scoreVal.textContent = score.toFixed(0);
 
    const headLevel = Number(payload.activity_H) || 0;
    const bodyLevel = Number(payload.activity_B) || 0;
    const legLevel = Number(payload.activity_L) || 0;
    const overallLevel = Number(payload.status_level) || Math.max(headLevel, bodyLevel, legLevel);
    const overallLabel = payload.status_label || activityLabels[overallLevel] || 'Idle';
    
    overviewRest.textContent = overallLabel;
    overviewRestBadge.textContent = overallLabel;
    setBadge(overviewRestBadge, overallLevel);
    
    const hints = [
      'Body appears calm.',
      'Minor movement detected — continue to observe.',
      'Significant movement detected — check patient.',
    ];
    overviewRestHint.textContent = hints[overallLevel] || hints[0];

    overviewMovement.textContent = `Head ${activityLabels[headLevel]} · Body ${activityLabels[bodyLevel]} · Leg ${activityLabels[legLevel]}`;
 
    const temp = Number(payload.TempC);
    const light = Number(payload.LightRaw);
    const sound = Number(payload.SoundRMS);
    overviewEnvironmentTemp.textContent = `${isNaN(temp) ? '–' : temp.toFixed(1)} °C`;
    overviewEnvironmentLight.textContent = `${isNaN(light) ? '–' : light.toFixed(0)}`;
    overviewEnvironmentSound.textContent = `${isNaN(sound) ? '–' : sound.toFixed(1)}`;

    const monitoring = Number(payload.monitoring) === 1 || payload.monitoring === true;
    overviewMonitoring.textContent = monitoring ? 'Active' : 'Paused';
    overviewMonitoringHint.textContent = monitoring ? 'System monitoring' : 'Monitoring paused';

    const time = Number(payload.time_s);
    overviewTime.textContent = isNaN(time) ? '0.0 s' : `${time.toFixed(1)} s`;
    timeVal.textContent = isNaN(time) ? '0.0 s' : `${time.toFixed(1)} s`;

    overviewEvents.textContent = `H${payload.minute_events_H || 0} · B${payload.minute_events_B || 0} · L${payload.minute_events_L || 0}`;

    // Update risk assessment (combine sleep and cognitive)
    updateRiskAssessment(score);
    }

  function updateRiskAssessment(sleepScore) {
    // Simple risk calculation - can be enhanced
    let risk = 'Low';
    let riskColor = 'badge-success';
    
    if (sleepScore < 50) {
      risk = 'High';
      riskColor = 'badge-danger';
    } else if (sleepScore < 70) {
      risk = 'Moderate';
      riskColor = 'badge-warning';
    }
    
    overviewRisk.textContent = risk;
    overviewRisk.className = `metric-value ${riskColor}`;
  }

  function describeScore(score) {
    if (score >= 85) return 'Excellent rest';
    if (score >= 70) return 'Generally restful';
    if (score >= 50) return 'Watch for disturbances';
    return 'High movement detected';
  }

  function handleData(payload) {
    timeVal.textContent = Number(payload.time_s).toFixed(1) + ' s';
    scoreVal.textContent = Number(payload.SleepScore).toFixed(0);
    rmsH.textContent = Number(payload.RMS_H).toFixed(1);
    rmsB.textContent = Number(payload.RMS_B).toFixed(1);
    rmsL.textContent = Number(payload.RMS_L).toFixed(1);
    setBadge(movH, payload.activity_H);
    setBadge(movB, payload.activity_B);
    setBadge(movL, payload.activity_L);
    const secH = Number(payload.secEv_H) || 0;
    const secB = Number(payload.secEv_B) || 0;
    const secL = Number(payload.secEv_L) || 0;
    const minH = Number(payload.minute_events_H) || 0;
    const minB = Number(payload.minute_events_B) || 0;
    const minL = Number(payload.minute_events_L) || 0;
    evSec.textContent = `H${secH} / B${secB} / L${secL}`;
    evMin.textContent = `H${minH} / B${minB} / L${minL}`;

    pushPoint(rmsChart, [payload.RMS_H, payload.RMS_B, payload.RMS_L]);
    pushPoint(auxChart, [payload.TempC, payload.LightRaw, payload.SoundRMS]);

    pointsA.textContent = `${rmsChart.data.labels.length} pts`;
    pointsB.textContent = `${auxChart.data.labels.length} pts`;
  }

  function setConnectedState(connected) {
    if (connected) {
      connectBtn.innerHTML = '<i class="fas fa-unlink"></i> <span>Disconnect</span>';
      connectBtn.classList.add('btn-secondary');
      statusEl.className = 'status-badge status-connected';
      statusEl.innerHTML = '<i class="fas fa-circle"></i> Connected';
    } else {
      connectBtn.innerHTML = '<i class="fas fa-plug"></i> <span>Connect</span>';
      connectBtn.classList.remove('btn-secondary');
      statusEl.className = 'status-badge status-disconnected';
      statusEl.innerHTML = '<i class="fas fa-circle"></i> Disconnected';
    }
  }

  // WebSocket connection
  let socket = null;

  function buildWsUrl() {
    if (window.location.protocol.startsWith('http')) {
      const isSecure = window.location.protocol === 'https:';
      const proto = isSecure ? 'wss' : 'ws';
      const host = window.location.hostname || 'localhost';
      const port = window.location.port || (isSecure ? '443' : '8000');
      return `${proto}://${host}:${port}/stream`;
      }
    return 'ws://localhost:8000/stream';
  }

  async function loadHistory() {
    try {
      const res = await fetch(`/api/history?limit=${maxPoints}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const rows = await res.json();
      if (Array.isArray(rows) && rows.length) {
      rows.forEach((payload, idx) => {
          handleData(payload);
        if (idx === rows.length - 1) updateOverview(payload);
      });
      }
      // Also load cognitive data for overview
      loadCognitiveData();
    } catch (e) {
      log('History load error: ' + e.message);
    }
  }

  connectBtn.onclick = () => {
    if (socket && socket.readyState === WebSocket.OPEN) {
      socket.close();
      return;
    }
    const url = buildWsUrl();
    log('Connecting to ' + url);
    socket = new WebSocket(url);

    socket.onopen = () => {
      log('Connected.');
      setConnectedState(true);
      hintEl.textContent = 'Connected to backend. Real-time data streaming active.';
    };

    socket.onmessage = (event) => {
      try {
        const msg = JSON.parse(event.data);
        if (msg.type === 'status') {
          log(`Status: ${msg.message}`);
        } else if (msg.type === 'data') {
          updateOverview(msg.payload);
          handleData(msg.payload);
        }
      } catch (err) {
        log('Message parse error: ' + err.message);
      }
    };

    socket.onclose = () => {
      log('Disconnected.');
      setConnectedState(false);
      socket = null;
    };

    socket.onerror = (err) => {
      log('WebSocket error: ' + err.message);
    };
  };

  clearBtn.onclick = async () => {
    const original = clearBtn.innerHTML;
    clearBtn.disabled = true;
    clearBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Clearing...';
    try {
      const res = await fetch('/api/reset', { method: 'POST' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      resetCharts();
      log('Dashboard cleared. Awaiting new data.');
    } catch (e) {
      log('Reset failed: ' + e.message);
    } finally {
      clearBtn.disabled = false;
      clearBtn.innerHTML = original;
    }
  };

  document.getElementById('clearLog').onclick = () => {
    logEl.textContent = '';
  };

  // Initialize
  loadHistory();
  setInterval(loadCognitiveData, 30000); // Refresh cognitive data every 30 seconds

})();
</script>
</body>
</html>
